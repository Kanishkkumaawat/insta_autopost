{% extends "layout.html" %}

{% block title %}Posting{% endblock %}
{% block page_title %}New Post{% endblock %}

{% block content %}
<div class="card">
    <div class="form-group">
        <label class="form-label">Select Accounts</label>
        <div id="account-selector" class="grid grid-3">
            <div class="text-muted">Loading accounts...</div>
        </div>
        <div style="margin-top: 0.5rem;">
            <a href="/auth/meta/login" class="btn btn-secondary" style="text-decoration: none;">Connect with Meta</a>
            <div class="text-sm text-muted" style="margin-top: 0.25rem;">Connect your Instagram via Meta to post, schedule, and use all features on your account.</div>
        </div>
    </div>

    <div class="form-group">
        <label class="form-label">Media Type</label>
        <div class="flex gap-2" id="media-type-buttons">
            <button type="button" class="btn btn-primary" data-type="image" onclick="setMediaType('image')">Image</button>
            <button type="button" class="btn btn-secondary" data-type="video" onclick="setMediaType('video')">Video</button>
            <button type="button" class="btn btn-secondary" data-type="reels" onclick="setMediaType('reels')">Reels</button>
            <button type="button" class="btn btn-secondary" data-type="carousel" onclick="setMediaType('carousel')">Carousel</button>
        </div>
        <input type="hidden" id="media-type" value="image">
    </div>

    <div class="form-group">
        <label class="form-label flex items-center gap-2" style="cursor: pointer;">
            <input type="checkbox" id="post-by-url-toggle" onchange="togglePostByUrl()">
            Post by URL (recommended for videos)
        </label>
        <div class="text-sm text-muted">Use Cloudinary, Imgur, S3, or any public HTTPS URL. Avoid Cloudflare tunnel URLs.</div>
    </div>

    <div id="post-by-url-section" class="form-group hidden">
        <label class="form-label">Media URLs</label>
        <textarea id="media-urls" class="form-control" rows="3" placeholder="https://res.cloudinary.com/.../video.mp4&#10;https://i.imgur.com/abc.png"></textarea>
        <div class="text-sm text-muted">One URL per line. Image: .jpg .png .webp. Video: .mp4 .mov</div>
        <div id="video-url-warning" class="text-sm" style="display: none; margin-top: 8px; padding: 8px; background: #fef3c7; border-radius: 4px; border-left: 3px solid #f59e0b;">
            <strong>‚ö†Ô∏è For Video/Reels:</strong> Use reliable hosting (Cloudinary, S3, Firebase). Avoid Cloudflare tunnels/ngrok.
        </div>
    </div>

    <div id="upload-section" class="form-group">
        <label class="form-label">Upload Media</label>
        <div id="drop-zone" class="upload-zone">
            <div class="upload-content">
                <span class="icon" style="font-size: 2rem;">‚òÅÔ∏è</span>
                <p>Drag & drop files here or click to select</p>
                <div class="text-sm text-muted">Supports JPG, PNG, MP4, MOV</div>
            </div>
            <input type="file" id="file-input" class="hidden" multiple accept="image/*,video/*">
        </div>
        <div id="file-list" class="flex flex-col gap-2 mt-4"></div>
    </div>

    <div class="form-group">
        <label class="form-label">Caption</label>
        <textarea id="caption" class="form-control" rows="5" placeholder="Write your caption here..."></textarea>
        <div class="flex justify-between text-sm text-muted mt-1">
            <span id="char-count">0 / 2200</span>
            <span id="hashtag-count">0 / 30 hashtags</span>
        </div>
    </div>

    <div class="form-group">
        <label class="form-label">Schedule (Optional)</label>
        <input type="datetime-local" id="scheduled-time" class="form-control">
    </div>

    <!-- Auto-DM Section -->
    <div class="form-group" style="border-top: 1px solid var(--border); padding-top: 1rem; margin-top: 1rem;">
        <label class="form-label flex items-center gap-2" style="cursor: pointer;">
            <input type="checkbox" id="auto-dm-toggle" checked onchange="toggleAutoDM()"> 
            Enable Auto-DM for this post
        </label>
        <div class="text-sm text-muted">Instagram allows DMs only if the user messaged you first (24h window). Commenting alone does not open DMs.</div>
        <div id="auto-dm-settings" class="hidden mt-2" style="margin-top: 0.5rem; padding-left: 1.5rem;">
            <div class="form-group">
                <label class="form-label text-sm">Link or File URL to Send</label>
                <input type="url" id="dm-link" class="form-control" placeholder="https://example.com/ebook.pdf">
                <div class="text-sm text-muted">Enter a direct URL to a PDF, image, or link</div>
            </div>
            <div class="form-group">
                <label class="form-label text-sm">Trigger Keyword (Optional)</label>
                <input type="text" id="dm-trigger" class="form-control" placeholder="e.g. SENDME">
                <div class="text-sm text-muted">Leave empty to reply to ANY comment (default: AUTO)</div>
            </div>
            <div class="form-group">
                <label class="form-label text-sm flex items-center gap-2" style="cursor: pointer;">
                    <input type="checkbox" id="auto-dm-ai-toggle">
                    Use AI Replies
                </label>
                <div class="text-sm text-muted">Generate DM text with AI (default: off)</div>
            </div>
        </div>
    </div>

    <div class="form-group">
        <button id="submit-btn" class="btn btn-primary w-full" onclick="submitPost()">Post Now</button>
    </div>
</div>

<!-- Batch Upload (30 Days) Section -->
<div class="card" style="margin-top: 2rem; border-top: 2px solid var(--primary);">
    <h2 style="margin-bottom: 1rem;">Batch Upload (30 Days)</h2>
    <div class="text-sm text-muted" style="margin-bottom: 1rem;">
        Upload multiple media files or a ZIP file to automatically schedule them as daily posts.
    </div>

    <div class="form-group">
        <label class="form-label">Select Account</label>
        <select id="batch-account-select" class="form-control">
            <option value="">Loading accounts...</option>
        </select>
    </div>

    <div class="form-group">
        <label class="form-label">Upload Method</label>
        <div class="flex gap-2" id="batch-upload-method-buttons">
            <button type="button" class="btn btn-primary" data-method="files" onclick="setBatchUploadMethod('files')">Multiple Files</button>
            <button type="button" class="btn btn-secondary" data-method="zip" onclick="setBatchUploadMethod('zip')">ZIP File</button>
        </div>
        <input type="hidden" id="batch-upload-method" value="files">
    </div>

    <div id="batch-files-section" class="form-group">
        <label class="form-label">Select Media Files (Max 31 files)</label>
        <div id="batch-drop-zone" class="upload-zone">
            <div class="upload-content">
                <span class="icon" style="font-size: 2rem;">üì¶</span>
                <p>Drag & drop multiple files here or click to select</p>
                <div class="text-sm text-muted">Supports JPG, PNG, WEBP, MP4, MOV, AVI, MKV, WEBM (Max 31 files, 100MB each)</div>
            </div>
            <input type="file" id="batch-file-input" class="hidden" multiple accept="image/*,video/*">
        </div>
        <div id="batch-file-list" class="flex flex-col gap-2 mt-4"></div>
    </div>

    <div id="batch-zip-section" class="form-group hidden">
        <label class="form-label">Upload ZIP File</label>
        <div id="batch-zip-drop-zone" class="upload-zone">
            <div class="upload-content">
                <span class="icon" style="font-size: 2rem;">üìÅ</span>
                <p>Drag & drop ZIP file here or click to select</p>
                <div class="text-sm text-muted">ZIP containing JPG, PNG, WEBP, MP4, MOV, AVI, MKV, WEBM files (Max 31 files total)</div>
            </div>
            <input type="file" id="batch-zip-input" class="hidden" accept=".zip">
        </div>
        <div id="batch-zip-info" class="mt-2"></div>
    </div>

    <div class="form-group">
        <label class="form-label">Start Date</label>
        <input type="datetime-local" id="batch-start-date" class="form-control" required>
        <div class="text-sm text-muted">First post will be scheduled for this date</div>
    </div>

    <div class="form-group">
        <label class="form-label">End Date (Optional)</label>
        <input type="datetime-local" id="batch-end-date" class="form-control">
        <div class="text-sm text-muted">If provided, files will be distributed across the date range. If not, posts will be scheduled daily from start date.</div>
    </div>

    <div class="form-group">
        <label class="form-label">Caption (Optional)</label>
        <textarea id="batch-caption" class="form-control" rows="3" placeholder="Caption for all posts..."></textarea>
    </div>

    <div class="form-group">
        <label class="form-label">Hashtags (Optional)</label>
        <input type="text" id="batch-hashtags" class="form-control" placeholder="#hashtag1 #hashtag2">
        <div class="text-sm text-muted">Space-separated hashtags</div>
    </div>

    <div class="form-group">
        <button id="batch-submit-btn" class="btn btn-primary w-full" onclick="submitBatchUpload()">Schedule Batch Campaign</button>
    </div>

    <div id="batch-result" class="mt-4"></div>
</div>

<!-- Modal for success/error -->
<div id="result-modal" class="modal hidden">
    <div class="modal-content card">
        <h3 id="modal-title">Result</h3>
        <p id="modal-message"></p>
        <button class="btn btn-primary" onclick="closeModal()">Close</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/posting.js"></script>
{% endblock %}
